---
const {
  name = "José Hernández",
  subtitle = "Ingeniero de Sistemas | Ciberseguridad (Penetración) y Hacking Ético | Infraestructura y Redes | Desarrollador Full-Stack",
} = Astro.props as { name?: string; subtitle?: string };
import "../styles/components/hero.css";
---
<section id="identity" class="section section--compact">
  <div class="flex flex-col lg:flex-row items-center lg:items-start gap-8 text-center lg:text-left">
    <div>
      <h1 class="text-4xl md:text-5xl font-semibold mb-1 flex flex-col lg:flex-row items-center gap-3 flex-wrap reveal-hero" style="--d:0;color:#d27389">
        <span class="hero-name glitch glitch-anim" data-text={name}>{name}</span>
        <span class="term-badge" data-term-typing>
          <span class="term-cmd"></span>
          <span class="term-cursor" aria-hidden="true"></span>
        </span>
      </h1>
      <p class="text-(--muted) max-w-3xl reveal-hero" style="--d:1">
        {subtitle}
      </p>
      <a
        href="#contact"
        aria-label="Ir a contacto"
        class="node node--compact contact-cta inline-flex items-center gap-3 mt-5 no-underline reveal-hero mx-auto lg:mx-0 py-3 px-6 text-base lg:py-2 lg:px-4"
        style="--d:2"
      >
        <span class="contact-cta__label font-semibold tracking-wide">Contactame</span>
        <svg class="opacity-70" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <path d="M7 17L17 7"/>
          <path d="M7 7h10v10"/>
        </svg>
      </a>
    </div>
      <figure class="silhouette-hover translate-y-1 reveal-hero mx-auto" style="--d:3; --silhouette-mask: url(img/lain-glich.gif);">
      <img
        src="img/lain-glich.gif"
        alt="Lain style ambient glitch"
        loading="lazy"
        class="w-52 lg:w-60 aspect-square object-cover transition-shadow"
      />
      <figcaption class="absolute -bottom-2 left-2 text-[10px] tracking-wide uppercase text-(--muted) opacity-70 select-none">
      </figcaption>
    </figure>
  </div>
</section>

<script>
// Tiny typing effect for elements marked with [data-term-typing]
// Works with multiple instances per page and respects reduced motion.

const DEFAULT_COMMANDS = [
  'whoami',
  'uname -sr',
  'echo "wired"',
  'sudo apt install curiosity',
  'ls -la ~/projects'
];

function parseCommandsAttr(attr: string | null): string[] {
  if (!attr) return DEFAULT_COMMANDS;
  try {
    const parsed = JSON.parse(attr);
    if (Array.isArray(parsed)) return parsed.map(String);
  } catch {}
  return attr.split(',').map((s: string) => s.trim()).filter(Boolean);
}

function initOne(root: Element) {
  // Avoid double init
  if ((root as any).__termInit) return;
  (root as any).__termInit = true;

  const cmdEl = root.querySelector<HTMLElement>('.term-cmd');
  if (!cmdEl) return;
  const cmd = cmdEl as HTMLElement;

  const prefersReduced = matchMedia('(prefers-reduced-motion: reduce)').matches;
  const cmds = parseCommandsAttr(root.getAttribute('data-commands'));

  let cmdIdx: number = 0;
  let charIdx: number = 0;
  let typing: boolean = true;
  let timer: number | undefined = undefined;

  const typeSpeed = 95;
  const eraseSpeed = 55;
  const holdTime = 1400;
  const idleTime = 800;

  function tick() {
    const text = `$ ${cmds[cmdIdx]}`;

    if (prefersReduced) {
      cmd.textContent = text;
      return;
    }

    if (typing) {
      cmd.textContent = text.slice(0, charIdx++);
      if (charIdx > text.length) {
        typing = false;
        timer = window.setTimeout(() => requestAnimationFrame(tick), holdTime);
        return;
      }
      window.setTimeout(() => requestAnimationFrame(tick), typeSpeed);
    } else {
      cmd.textContent = text.slice(0, charIdx--);
      if (charIdx < 2) {
        typing = true;
        cmdIdx = (cmdIdx + 1) % cmds.length;
        timer = window.setTimeout(() => requestAnimationFrame(tick), idleTime);
        return;
      }
      window.setTimeout(() => requestAnimationFrame(tick), eraseSpeed);
    }
  }

  tick();
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      if (timer !== undefined) window.clearTimeout(timer);
    } else {
      requestAnimationFrame(tick);
    }
  });
}

function initAll() {
  document.querySelectorAll('[data-term-typing]').forEach(initOne);
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initAll);
} else {
  initAll();
}

// Animación reveal y glitch
document.addEventListener('DOMContentLoaded', () => {
  const root = document.getElementById('identity');
  if (!root) return;
  const items = root.querySelectorAll('.reveal-hero');
  const nameEl = root.querySelector('.hero-name');

  const prefersReduced = matchMedia('(prefers-reduced-motion: reduce)').matches;
  if (prefersReduced) {
    items.forEach(i => i.classList.add('is-visible'));
    return;
  }

  const io = new IntersectionObserver((entries, obs) => {
    entries.forEach(e => {
      if (e.isIntersecting) {
        e.target.classList.add('is-visible');
        obs.unobserve(e.target);
      }
    });
  }, { threshold: 0.2 });

  items.forEach(el => io.observe(el));

  // Trigger a short glitch burst once when the title first becomes visible
  const nameObserver = new IntersectionObserver((entries, obs) => {
    entries.forEach(e => {
      if (e.isIntersecting && nameEl) {
        nameEl.classList.add('glitch-lain');
        setTimeout(() => nameEl.classList.remove('glitch-lain'), 1200);
        obs.disconnect();
      }
    });
  }, { threshold: 0.6 });
  if (nameEl) nameObserver.observe(nameEl);
});
</script>
<style>
  /* Term-badge: reservar ancho estable para evitar 'jumping' */
  .term-badge { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, 'Roboto Mono', 'Courier New', monospace; display:inline-flex; align-items:center; gap:0.4rem; }
  .term-cmd { display:inline-block; min-width:18ch; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  @media (min-width: 1024px) {
    .term-cmd { min-width:28ch; }
  }
  .term-cursor { display:inline-block; width:0.45rem; height:1.05em; background:currentColor; border-radius:2px; margin-left:0.25rem; opacity:0.95; animation:tb-blink 1s steps(2,start) infinite; }
  @keyframes tb-blink { 50% { opacity:0; } }

  /* Mobile adjustments: centrar y permitir que term-cmd ocupe su propio renglón */
  @media (max-width: 767px) {
    /* Make the hero fill the viewport so the next card isn't cut */
    #identity { min-height: calc(100vh - 64px); padding-top: 24px; padding-bottom: 32px; display:flex; align-items:center; }
    #identity > div { align-items:center; }
    h1.reveal-hero { text-align:center; }
    h1.reveal-hero { align-items:center; }
    h1.reveal-hero .hero-name { display:block; margin-bottom:0.5rem; }
    h1.reveal-hero .term-cmd { min-width:0; display:block; margin:0.3rem auto 0; }
    p.reveal-hero { text-align:center; margin-top:0.8rem; margin-bottom:1rem; }
    .contact-cta { margin:0.9rem auto 0; padding:0.75rem 1.25rem; font-size:1.05rem; }
    figure.silhouette-hover { margin-top:1.25rem; margin-left:0; margin-right:0; }
    figure.silhouette-hover img { width:13rem; height:auto; }
  }

  /* Más separación entre el título (h1) + term-badge y el subtítulo */
  h1.reveal-hero + p.reveal-hero { margin-top: 1rem; }
  @media (max-width: 767px) {
    h1.reveal-hero + p.reveal-hero { margin-top: 1.2rem; }
  }

  /* Add extra space below the gif to avoid touching TerminalCard */
  .silhouette-hover { margin-bottom: 2.5rem; }
  @media (max-width: 767px) {
    .silhouette-hover { margin-bottom: 4rem; }
  }
</style>
